# Bilibili å¼¹å¹•æ’ä»¶ (Seleniumç‰ˆ)

## åŠŸèƒ½ä»‹ç»

è¿™ä¸ªæ’ä»¶ä½¿ç”¨ Selenium WebDriver ç›´æ¥ä» Bilibili ç›´æ’­é—´é¡µé¢è·å–å¼¹å¹•å’Œç¤¼ç‰©æ¶ˆæ¯ï¼Œç›¸æ¯” API ç‰ˆæœ¬å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **å®æ—¶æ€§æ›´å¥½**: ç›´æ¥ä»é¡µé¢è·å–ï¼Œæ— éœ€ç­‰å¾… API æ›´æ–°
- **ä¿¡æ¯æ›´å…¨é¢**: å¯ä»¥è·å–ç¤¼ç‰©ã€è¿›å…¥ç›´æ’­é—´ç­‰å¤šç§æ¶ˆæ¯ç±»å‹
- **æ›´ç¨³å®š**: ä¸ä¾èµ–å¯èƒ½å˜åŒ–çš„ API æ¥å£

## æ–°å¢åŠŸèƒ½

### 1. è·³è¿‡åˆå§‹å¼¹å¹• âœ¨
- **åŠŸèƒ½**: åªå‘é€æ–°å¢å¼¹å¹•ï¼Œä¸å‘é€ç¬¬ä¸€æ¬¡è¯»å–æ—¶å·²å­˜åœ¨çš„å¼¹å¹•
- **é…ç½®**: `skip_initial_danmaku = true`
- **è¯´æ˜**: å¯ç”¨åï¼Œæ’ä»¶ä¼šç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½ï¼Œç„¶ååªå¤„ç†ä¹‹åå‡ºç°çš„æ–°å¼¹å¹•ï¼Œé¿å…é‡å¤å¤„ç†å†å²å¼¹å¹•

### 2. å¼¹å¹•ä¿å­˜åŠŸèƒ½ ğŸ’¾
- **åŠŸèƒ½**: è‡ªåŠ¨å°†è·å–åˆ°çš„å¼¹å¹•ä¿å­˜ä¸ºJSONLæ ¼å¼æ–‡ä»¶
- **é…ç½®**: 
  - `enable_danmaku_save = true` - å¯ç”¨ä¿å­˜åŠŸèƒ½
  - `danmaku_save_file = "danmaku_123456.jsonl"` - æŒ‡å®šä¿å­˜æ–‡ä»¶å
- **ä¿å­˜ä½ç½®**: æ–‡ä»¶ä¿å­˜åœ¨ `src/plugins/bili_danmaku_selenium/data/` ç›®å½•ä¸‹
- **æ–‡ä»¶æ ¼å¼**: æ¯è¡Œä¸€ä¸ªJSONå¯¹è±¡ï¼ŒåŒ…å«å®Œæ•´çš„MessageBaseä¿¡æ¯

### 3. ä»æ–‡ä»¶è¯»å–å¼¹å¹• ğŸ“„
- **åŠŸèƒ½**: ä»ä¹‹å‰ä¿å­˜çš„å¼¹å¹•æ–‡ä»¶ä¸­è¯»å–å¹¶é‡æ–°å‘é€å¼¹å¹•
- **é…ç½®**:
  - `enable_danmaku_load = true` - å¯ç”¨è¯»å–åŠŸèƒ½
  - `danmaku_load_file = "danmaku_123456.jsonl"` - æŒ‡å®šè¦è¯»å–çš„æ–‡ä»¶å
- **è¯»å–ä½ç½®**: ä» `src/plugins/bili_danmaku_selenium/data/` ç›®å½•è¯»å–
- **ä½¿ç”¨åœºæ™¯**: 
  - æµ‹è¯•å’Œè°ƒè¯•
  - é‡æ”¾å†å²å¼¹å¹•
  - ç¦»çº¿æ¨¡å¼è¿è¡Œ

### 4. çº¯æ–‡ä»¶æ¨¡å¼ âš¡
- **åŠŸèƒ½**: å½“å¯ç”¨æ–‡ä»¶è¯»å–æ—¶ï¼Œè‡ªåŠ¨è¿›å…¥çº¯æ–‡ä»¶æ¨¡å¼
- **ç‰¹ç‚¹**:
  - ä¸å¯åŠ¨æµè§ˆå™¨ï¼Œå®Œå…¨ç¦»çº¿è¿è¡Œ
  - æŒ‰ç…§æ–‡ä»¶ä¸­è®°å½•çš„æ—¶é—´è½´ç²¾ç¡®é‡æ”¾å¼¹å¹•
  - ä¿æŒåŸå§‹å¼¹å¹•çš„æ—¶é—´é—´éš”
- **é…ç½®**: 
  ```toml
  enable_danmaku_load = true
  danmaku_load_file = "replay_data.jsonl"
  # enable_danmaku_save = true  # å¯é€‰ï¼ŒåŒæ—¶ä¿å­˜æ–°ç”Ÿæˆçš„å¼¹å¹•
  ```
- **ä¼˜åŠ¿**: èµ„æºå ç”¨æä½ï¼Œé‡æ”¾æ—¶é—´ç²¾ç¡®ï¼Œé€‚åˆæµ‹è¯•å’Œæ¼”ç¤º

## é…ç½®ç¤ºä¾‹

```toml
[bili_danmaku_selenium]
# åŸºæœ¬è®¾ç½®
room_id = 123456
poll_interval = 1.0

# å¼¹å¹•å¤„ç†è®¾ç½®
skip_initial_danmaku = true        # è·³è¿‡åˆå§‹å¼¹å¹•
enable_danmaku_save = true         # å¯ç”¨å¼¹å¹•ä¿å­˜
danmaku_save_file = "live_123456.jsonl"  # ä¿å­˜æ–‡ä»¶å
enable_danmaku_load = false        # ä¸ä»æ–‡ä»¶è¯»å–
danmaku_load_file = ""             # è¯»å–æ–‡ä»¶åï¼ˆç©ºè¡¨ç¤ºä¸è¯»å–ï¼‰
```

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå½•åˆ¶å¼¹å¹•ç”¨äºåç»­åˆ†æ
```toml
skip_initial_danmaku = true
enable_danmaku_save = true
danmaku_save_file = "analysis_data.jsonl"
enable_danmaku_load = false
```

### åœºæ™¯2ï¼šé‡æ”¾å†å²å¼¹å¹•è¿›è¡Œæµ‹è¯•
```toml
skip_initial_danmaku = false
enable_danmaku_save = false
enable_danmaku_load = true
danmaku_load_file = "test_data.jsonl"
```

### åœºæ™¯3ï¼šåŒæ—¶å½•åˆ¶å’Œè¯»å–ï¼ˆæ··åˆæ¨¡å¼ï¼‰
```toml
skip_initial_danmaku = true
enable_danmaku_save = true
danmaku_save_file = "new_data.jsonl"
enable_danmaku_load = true
danmaku_load_file = "old_data.jsonl"
```

### åœºæ™¯4ï¼šçº¯æ–‡ä»¶é‡æ”¾æ¨¡å¼ï¼ˆç¦»çº¿æµ‹è¯•ï¼‰
```toml
skip_initial_danmaku = false  # ä¸è·³è¿‡ï¼Œå› ä¸ºæ˜¯é‡æ”¾
enable_danmaku_save = false   # ä¸ä¿å­˜ï¼Œçº¯é‡æ”¾
enable_danmaku_load = true    # å¯ç”¨æ–‡ä»¶è¯»å–
danmaku_load_file = "test_replay.jsonl"
# å¯ç”¨æ–‡ä»¶è¯»å–ä¼šè‡ªåŠ¨è¿›å…¥çº¯æ–‡ä»¶æ¨¡å¼ï¼Œä¸å¯åŠ¨æµè§ˆå™¨
```

## ä¾èµ–å®‰è£…

```bash
pip install selenium
```

è¿˜éœ€è¦å®‰è£… Chrome æµè§ˆå™¨å’Œå¯¹åº”ç‰ˆæœ¬çš„ ChromeDriverï¼Œæˆ–è€…é…ç½®ä½¿ç”¨å…¶ä»–æµè§ˆå™¨ã€‚

## é…ç½®è¯´æ˜

### åŸºæœ¬é…ç½®

- `room_id`: Bç«™ç›´æ’­é—´å·ç 
- `poll_interval`: æ£€æŸ¥å¼¹å¹•çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå»ºè®® 1-2 ç§’
- `max_messages_per_check`: æ¯æ¬¡æ£€æŸ¥æœ€å¤šå¤„ç†çš„æ¶ˆæ¯æ•°é‡

### å¼¹å¹•æ–‡ä»¶å¤„ç†é…ç½®

- `skip_initial_danmaku`: æ˜¯å¦è·³è¿‡åˆå§‹å¼¹å¹•ï¼Œåªå¤„ç†æ–°å¢å¼¹å¹•
- `enable_danmaku_save`: æ˜¯å¦è‡ªåŠ¨ä¿å­˜å¼¹å¹•åˆ°æ–‡ä»¶
- `danmaku_save_file`: ä¿å­˜å¼¹å¹•çš„æ–‡ä»¶å
- `enable_danmaku_load`: æ˜¯å¦ä»æ–‡ä»¶è¯»å–å¼¹å¹•
- `danmaku_load_file`: è¦è¯»å–çš„å¼¹å¹•æ–‡ä»¶å

### Selenium é…ç½®

- `headless`: æ˜¯å¦ä½¿ç”¨æ— å¤´æ¨¡å¼è¿è¡Œæµè§ˆå™¨ï¼ˆå»ºè®® trueï¼‰
- `webdriver_timeout`: WebDriver æ“ä½œè¶…æ—¶æ—¶é—´
- `page_load_timeout`: é¡µé¢åŠ è½½è¶…æ—¶æ—¶é—´
- `implicit_wait`: éšå¼ç­‰å¾…æ—¶é—´
- `chromedriver_path`: ChromeDriverå¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„
  - è‹¥æŒ‡å®šï¼Œå°†ä¼˜å…ˆä½¿ç”¨æ­¤è·¯å¾„
  - è‹¥ä¸æŒ‡å®šæˆ–è·¯å¾„æ— æ•ˆï¼Œå°†å°è¯•ä½¿ç”¨webdriver-manageræˆ–ç³»ç»Ÿå®‰è£…çš„ChromeDriver

### é€‰æ‹©å™¨é…ç½®

å¯ä»¥æ ¹æ® Bilibili é¡µé¢ç»“æ„çš„å˜åŒ–è°ƒæ•´è¿™äº› CSS é€‰æ‹©å™¨ï¼š

- `danmaku_container_selector`: å¼¹å¹•å®¹å™¨çš„é€‰æ‹©å™¨
- `danmaku_item_selector`: å•æ¡å¼¹å¹•çš„é€‰æ‹©å™¨
- `danmaku_text_selector`: å¼¹å¹•æ–‡æœ¬çš„é€‰æ‹©å™¨
- `username_selector`: ç”¨æˆ·åçš„é€‰æ‹©å™¨
- `gift_selector`: ç¤¼ç‰©æ¶ˆæ¯çš„é€‰æ‹©å™¨
- `gift_text_selector`: ç¤¼ç‰©æ–‡æœ¬çš„é€‰æ‹©å™¨

## ç‰¹è‰²åŠŸèƒ½

### æ¶ˆæ¯å»é‡

æ’ä»¶ä¼šè‡ªåŠ¨è®°å½•å·²å¤„ç†çš„æ¶ˆæ¯ï¼Œé˜²æ­¢é‡å¤å¤„ç†åŒä¸€æ¡å¼¹å¹•ã€‚

### å¤šç±»å‹æ¶ˆæ¯æ”¯æŒ

- **å¼¹å¹•æ¶ˆæ¯**: æ™®é€šçš„æ–‡å­—å¼¹å¹•
- **ç¤¼ç‰©æ¶ˆæ¯**: è§‚ä¼—é€ç¤¼ç‰©çš„æ¶ˆæ¯ï¼ŒåŒ…å«ç¤¼ç‰©åç§°å’Œæ•°é‡

### è‡ªåŠ¨é‡è¿

å½“ç½‘ç»œå¼‚å¸¸æˆ–é¡µé¢é—®é¢˜æ—¶ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨é‡è¯•ï¼Œç¡®ä¿æŒç»­ç›‘æ§ã€‚

### å†…å­˜ä¼˜åŒ–

å®šæœŸæ¸…ç†å·²å¤„ç†æ¶ˆæ¯çš„è®°å½•ï¼Œé˜²æ­¢é•¿æ—¶é—´è¿è¡Œå¯¼è‡´å†…å­˜å ç”¨è¿‡å¤§ã€‚

## æ–‡ä»¶æ ¼å¼è¯´æ˜

ä¿å­˜çš„å¼¹å¹•æ–‡ä»¶ä½¿ç”¨JSONLæ ¼å¼ï¼ˆJSON Linesï¼‰ï¼Œæ¯è¡Œä¸€ä¸ªJSONå¯¹è±¡ï¼š

```json
{"message_info": {"platform": "bili", "message_id": "bili_selenium_123456_1234567890_abc123", "time": 1234567890, "user_info": {"platform": "bili", "user_id": "bili_user", "user_nickname": "è§‚ä¼—åå­—"}, "format_info": {"content_format": ["text"], "accept_format": ["text"]}, "additional_config": {"source": "bili_danmaku_selenium_plugin"}}, "message_segment": {"type": "text", "data": "å¼¹å¹•å†…å®¹"}, "raw_message": "å¼¹å¹•å†…å®¹"}
```

## æ³¨æ„äº‹é¡¹

1. **Chromeæµè§ˆå™¨**: ç¡®ä¿ç³»ç»Ÿå®‰è£…äº†Chromeæµè§ˆå™¨
2. **ChromeDriver**: éœ€è¦å¯¹åº”ç‰ˆæœ¬çš„ChromeDriverï¼Œå»ºè®®ä½¿ç”¨webdriver-managerè‡ªåŠ¨ç®¡ç†
3. **ç½‘ç»œç¯å¢ƒ**: éœ€è¦èƒ½æ­£å¸¸è®¿é—®Bilibiliç›´æ’­é—´
4. **èµ„æºå ç”¨**: Seleniumä¼šæ¶ˆè€—è¾ƒå¤šç³»ç»Ÿèµ„æºï¼Œå»ºè®®åœ¨æ€§èƒ½è¾ƒå¥½çš„æœºå™¨ä¸Šè¿è¡Œ
5. **æ–‡ä»¶æƒé™**: ç¡®ä¿æ’ä»¶æœ‰è¯»å†™dataç›®å½•çš„æƒé™
6. **æ–‡ä»¶å¤§å°**: é•¿æ—¶é—´å½•åˆ¶ä¼šäº§ç”Ÿè¾ƒå¤§æ–‡ä»¶ï¼Œæ³¨æ„ç£ç›˜ç©ºé—´

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **WebDriverå¯åŠ¨å¤±è´¥**: æ£€æŸ¥Chromeå’ŒChromeDriverç‰ˆæœ¬æ˜¯å¦åŒ¹é…
2. **é¡µé¢åŠ è½½è¶…æ—¶**: å¢åŠ `page_load_timeout`çš„å€¼
3. **å¼¹å¹•è·å–ä¸åˆ°**: æ£€æŸ¥CSSé€‰æ‹©å™¨æ˜¯å¦éœ€è¦æ›´æ–°
4. **æ–‡ä»¶è¯»å†™å¤±è´¥**: æ£€æŸ¥dataç›®å½•æƒé™å’Œç£ç›˜ç©ºé—´

## ä¸ API ç‰ˆæœ¬çš„å¯¹æ¯”

| ç‰¹æ€§       | Seleniumç‰ˆ | APIç‰ˆ |
| ---------- | ---------- | ----- |
| å®æ—¶æ€§     | ä¼˜ç§€       | è‰¯å¥½  |
| ç¨³å®šæ€§     | è‰¯å¥½       | ä¼˜ç§€  |
| èµ„æºå ç”¨   | è¾ƒé«˜       | ä½    |
| æ¶ˆæ¯ç±»å‹   | ä¸°å¯Œ       | æœ‰é™  |
| é…ç½®å¤æ‚åº¦ | è¾ƒé«˜       | ä½    |

æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ä½¿ç”¨ã€‚